!function(e,t){var a;t.GLOBALAJAX={getAddressListUrl:"/m-flow-a-address_list.html",saveAddressUrl:"/m-flow-a-consignee.html",setDefaultAddressUrl:"/m-flow-a-defaultaddress.html",deleteAddressUrl:"/m-flow-a-delete_address.html",setCurrentUseAddressUrl:"/m-flow-a-currentaddress.html",editAddressUrl:"/m-flow-a-edit_address.html",getExchangeCoupon:"/m-flow-a-get_coupon.html",getCartDataUrl:"/m-flow-a-get_cart.html",useCouponUrl:"/m-flow-a-coupon.html",useCommissionUrl:"/m-flow-a-cash.html",getSecurityCode:"/m-flow-a-send_message.html",addressTmp:"address_tmp",addressWarp:"js_address_warp",checkoutTmp:"checkout_tmp",orderConfirmForm:"js_order_confirm_form",userEditAddressUrl:"m-users-a-user_address.htm?edit_address_id={address_id}",getCartAjaxPromise:function(t,a,s){a=arguments.length>1?a:!0;var n={type:"POST",global:!0,dataType:"json"};t=e.extend({},n,t);var r=e.ajax(t);return a&&this.ajaxSuccessCall(r,s),r},ajaxSuccessCall:function(e,t){var a=this;e.done(function(e){if(0!=e.status)a.ajaxSuccessFailCall(e);else{if("undefined"==typeof t)return;a.render(e,t)}})},ajaxSuccessFailCall:function(e){var a=e.msg;layer.alert(a,function(){t.location.reload(!0)})},render:function(t,a){var s=document.getElementById(a[0]).innerHTML;return"undefined"==typeof t.data?void layer.alert("亮老板数据返回错误 。。"):(a[0]==GLOBALAJAX.addressTmp&&(t.data.address_list.length<=0?(e(".js_add_aaddress,.js_address_confirm_cancel").hide(),e(ORDERADDRESS.addressFormId).show(),ORDERADDRESS.addressForm instanceof ADDRESSFORM&&ORDERADDRESS.addressForm.formReset(),ORDERADDRESS.renderCallBack()):(e(".js_add_aaddress,.js_address_confirm_cancel").show(),e(ORDERADDRESS.addressFormId).hide())),void laytpl(s).render(t.data,function(s){document.getElementById(a[1]).innerHTML=s,a[2]=a[2]||e.noop,a[2].call(ORDERADDRESS,t)}))}},t.ORDERADDRESS={addressForm:"",addressFormId:"#delivery_address_form",layerIndex:null,init:function(){var e=this,a=GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.getAddressListUrl},!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWarp,function(t){e.renderCallBack(),e.checkPopVerified(t.data.verified)}]);a.fail(function(){layer.alert("获取数据失败！",function(){t.location.reload(!0)})}),this.initUseCurrentEvent()},renderCallBack:function(){var a=this;!e(a.addressFormId).is(":visible")||a.addressForm instanceof ADDRESSFORM||(a.addressForm=new ADDRESSFORM(e(a.addressFormId),function(){var s=e(a.addressFormId).serialize();GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.saveAddressUrl,data:s},!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWarp,function(){layer.close(a.layerIndex)}]).fail(function(){layer.alert("保存失败！",function(){t.location.reload(!0)})})}))},allOperating:function(e){return e=e||{},GLOBALAJAX.getCartAjaxPromise(e,!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWarp])},setCurrentStyle:function(e){e.closest(".js_addressTable").find(".js_address_label").removeClass("checked"),e.addClass("checked")},setDefaultStyle:function(t){var a=e("#"+GLOBALAJAX.addressWarp).find(".js_defaultWarp");a.removeClass("js_defaultWarp"),a.find(".js_default").addClass("hidden"),a.find(".js_setDefault").removeClass("hidden");var s=t.closest(".js_address_label");s.addClass("js_defaultWarp"),s.find(".js_default").removeClass("hidden"),s.find(".js_setDefault").addClass("hidden")},setDefaultAndCurrent:function(t){return t=e.extend({global:!0},t),GLOBALAJAX.getCartAjaxPromise(t,!0)},openPop:function(t,a){var s=e("#js_pop"),n=this;if(t=e.extend({},{type:1,shadeClose:!1,title:"提示",area:["500px","350px"],content:s,end:function(){}},t),n.layerIndex=layer.open(t),a=arguments.length>1?a:!1){s=t.content;var r=s.find(".js_cancel");r.off("click"),r.on("click",function(e){e.preventDefault(),layer.close(n.layerIndex)})}},checkPopVerified:function(t){var s="1"==a&&0==t&&e(".js_address_label").length>0;if(s){var n=e(".js_address_label").filter(".checked").data("address-id");e(".js_addressVer").attr("href",GLOBALAJAX.userEditAddressUrl.replace("{address_id}",n)),this.openPop({area:["500px","320px"]},!0)}return!s},initUseCurrentEvent:function(){var a=this;e("#js_address_warp").on("click",".js_address_label",function(){var s=e(this),n=s.data("address-id")||0;s.hasClass("checked")||a.setDefaultAndCurrent({url:GLOBALAJAX.setCurrentUseAddressUrl,data:{address_id:n}}).fail(function(){layer.alert("选择失败，点击确定重试",function(){t.location.reload(!0)})}).done(function(e){0==e.status&&(a.setCurrentStyle(s),a.checkPopVerified(e.data.verified))})}),e(".js_add_aaddress").on("click",function(t){return t.preventDefault(),e("#"+GLOBALAJAX.addressWarp).find(".js_address_label").length>=9?(layer.alert("最多设置 9 个收货地址，请先删除"),!1):void a.editOrAdd()}),e(".js_address_confirm_cancel").click(function(e){e.preventDefault(),layer.close(a.layerIndex)})},stopPropagation:function(e){e&&e.stopPropagation?e.stopPropagation():t.event.cancelBubble=!0},setDefaultEvent:function(a,s,n){var r=this;r.stopPropagation(s),r.setDefaultAndCurrent({url:GLOBALAJAX.setDefaultAddressUrl,data:{address_id:n}}).fail(function(){layer.alert("设置当前默认失败，点击确定重试",function(){t.location.reload(!0)})}).done(function(){r.setDefaultStyle(e(a))})},deleteEvent:function(e,a){var s=this;this.stopPropagation(e),layer.confirm("确定要删除该收货地址吗？",{btn:["确认","取消"],shade:.3},function(){s.allOperating({url:GLOBALAJAX.deleteAddressUrl,data:{address_id:a}}).fail(function(){layer.alert("删除失败，点击确定重试",function(){t.location.reload(!0)})})},function(){})},editEvent:function(e,a){var s=this;this.stopPropagation(e),GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.editAddressUrl,data:{address_id:a}},!0).done(function(e){return 0==e.status?s.editOrAdd(e):void 0}).fail(function(){layer.alert("获取数据失败，点击确定重试",function(){t.location.reload(!0)})})},showAllEvent:function(t){this.stopPropagation(t),e(".show_all").show(),e(".js_showAllAddress").remove()},checkIsJsonData:function(t){var a="object"==typeof t&&"[object object]"==Object.prototype.toString.call(t).toLowerCase()&&!t.length;if(a)return t;if("string"==typeof t)try{return e.parseJSON(t)}catch(s){return!1}},bindFormData:function(t){if(this.checkIsJsonData(t)){var a=e(this.addressFormId);a.find("input").each(function(){this.value="undefined"==typeof t.data[this.name]?"":t.data[this.name]}),a.find("textarea").each(function(){this.value="undefined"==typeof t.data[this.name]?"":t.data[this.name]}),a.find(".hidden-input").each(function(){var a="undefined"==typeof t.data[this.name]||1!=t.data[this.name]?!1:!0;this.checked=a,this.value=1,a?e(this).siblings(".icon_checkbox").addClass("selected"):e(this).siblings(".icon_checkbox").removeClass("selected")}),a.find("select").each(function(){var a='<option value="default">'+e(this).find("option:first").text()+"</option>",s=t.data[this.name];if(!(s.length>0))return!1;e(this).parent().show();for(var n=0;n<s.length;n++)a+="1"==s[n].is_current?'<option selected="selected" value="'+s[n].id+'">'+s[n].value+"</option>":'<option value="'+s[n].id+'">'+s[n].value+"</option>";e(this).html(a)})}},editOrAdd:function(a){var s;ORDERADDRESS.addressForm instanceof ADDRESSFORM&&ORDERADDRESS.addressForm.formReset(),"undefined"!=typeof a?(s="修改收货地址",this.bindFormData(a)):(s="添加收货地址",e(ORDERADDRESS.addressFormId).find("input[name=address_id]").val(""));var n=.8*e(t).height();n=(n>600?600:n)+"px",this.layerIndex=layer.open({type:1,shadeClose:!1,title:s,area:["800px",n],content:e(this.addressFormId)}),this.renderCallBack()}},t.CHECKOUT={selectTimer:null,securityCodeTimer:null,countdownTimer:null,setCheckBox:function(t){e(t).toggleClass("selected");var a=e(t).siblings(".hidden-input")[0];a.checked=!a.checked},init:function(){this.allOperating({url:GLOBALAJAX.getCartDataUrl}).fail(function(){layer.alert("获取订单列表失败，点击确定重试",function(){t.location.reload(!0)})}),this.bindEvent()},bindEvent:function(){var a=this,s=e("#"+GLOBALAJAX.orderConfirmForm);s.on("click",".js_use_coupon,.js_use_commission",function(){var s=e(this);if(s.parent().siblings(".js_none_show").toggleClass("none"),s.hasClass("js_use_commission")){var n=e(".js_use_commission_money")[0];n.disabled=!n.disabled}clearTimeout(this.selectTimer),this.selectTimer=setTimeout(function(){if(!s.hasClass("selected"))if(s.hasClass("js_use_coupon")){if("default"==s.closest(".user_coupon_warp").find(".item-select").val())return;a.allOperating({url:GLOBALAJAX.useCouponUrl,data:{code:0}}).fail(function(){layer.alert("取消优惠券使用失败，点击确定重试",function(){t.location.reload(!0)})})}else s.parent().parent().find(".form-error").remove(),a.allOperating({url:GLOBALAJAX.useCommissionUrl,data:{commission:0}}).fail(function(){layer.alert("取消使用佣金失败，点击确定重试",function(){t.location.reload(!0)})})},100)}),s.on("click",".js_get_commission_code",function(s){s.preventDefault(),$this=e(this),$this.hasClass("disabled")||GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.getSecurityCode},!0).done(function(t){if(0==t.status){$this.addClass("disabled").data("default-text",$this.text()),e(".js_send_code_msg").show();var s=60;clearInterval(a.countdownTimer),a.countdownTimer=setInterval(function(){$this.text(s),s--,0>=s&&($this.removeClass("disabled").text($this.data("default-text")),clearInterval(a.countdownTimer))},1e3)}}).fail(function(){layer.alert("获取验证码失败，点击确定重试",function(){t.location.reload(!0)})})}),s.on("click",".js_userCoponCode",function(){s.find(".js_couponCodeWarp").toggle()})},checkCoupon:function(){var t=e("#"+GLOBALAJAX.orderConfirmForm).find(".js_couponCode"),a=t.val().length>=8&&t.val().length<=16?t.val():!1;return a||layer.alert("请输入正确的优惠券兑换码！",{end:function(){t.val("").focus()}}),a},exchangeCoupon:function(){var e=this.checkCoupon();e&&this.allOperating({url:GLOBALAJAX.getExchangeCoupon,data:{coupon_code:e}}).fail(function(){layer.alert("兑换失败")})},getSecurityCodeEvent:function(){},checkisNna:function(e){return!isNaN(e)},commissionChangeEvent:function(t){var a=parseFloat(e(t).data("has-commission")),s=parseFloat(t.value);""==t.value||this.checkisNna(s)&&a>=s||(t.value=a)},securityCodeValidate:function(t){return e(t).removeClass("form-error"),e(t).parent().parent().find(".form-error").remove(),6==t.value.length?!0:(e(t).addClass("form-error").focus(),e(t).parent().parent().append("<p class='form-error' style = 'padding: 5px 153px 0 0;'>验证码长度为6位</p>"),!1)},inputCheckSecurityCodeEvent:function(a){var s=this;clearTimeout(this.securityCodeTimer),s.securityCodeTimer=setTimeout(function(){if(s.securityCodeValidate(a)){if(""==e(".js_use_commission_money")[0].value)return layer.alert("请输入要使用的佣金金额",{end:function(){e(".js_use_commission_money").focus()}}),a.value="",!1;s.allOperating({url:GLOBALAJAX.useCommissionUrl,data:{commission:e(".js_use_commission_money")[0].value,security_code:a.value}}).fail(function(){layer.alert("使用佣金失败，点击确定重试",function(){t.location.reload(!0)})})}},1e3)},selectCouponEvent:function(e){var a="default"==e.value?0:e.value;this.allOperating({url:GLOBALAJAX.useCouponUrl,data:{code:a}}).fail(function(){layer.alert("选择优惠券失败，点击确定重试",function(){t.location.reload(!0)})})},allOperating:function(e){return e=e||{},GLOBALAJAX.getCartAjaxPromise(e,!0,[GLOBALAJAX.checkoutTmp,GLOBALAJAX.orderConfirmForm])}},e(function(){a=e("#js_directMail").val(),ORDERADDRESS.init(),CHECKOUT.init()})}(jQuery,window);