!function($,window){var directMail;window.GLOBALAJAX={getAddressListUrl:"/m-flow-a-address_list.html",saveAddressUrl:"/m-flow-a-consignee.html",setDefaultAddressUrl:"/m-flow-a-defaultaddress.html",deleteAddressUrl:"/m-flow-a-delete_address.html",setCurrentUseAddressUrl:"/m-flow-a-currentaddress.html",editAddressUrl:"/m-flow-a-edit_address.html",useGiftCartUrl:"/m-flow-a-use_giftcard.html",bindGiftCartUrl:"/m-flow-a-bind_giftcard.html",getExchangeCoupon:"/m-flow-a-get_coupon.html",getCartDataUrl:"/m-flow-a-get_cart.html",useCouponUrl:"/m-flow-a-coupon.html",useCommissionUrl:"/m-flow-a-cash.html",getSecurityCode:"/m-flow-a-send_message.html",addressTmp:"address_tmp",addressWrap:"js_address_warp",checkoutTmp:"checkout_tmp",orderConfirmForm:"js_order_confirm_form",userEditAddressUrl:"m-users-a-user_address.htm?edit_address_id={address_id}",getCartAjaxPromise:function(e,t,a){t=arguments.length>1?t:!0;var n={doneHasErrorIsReload:!0,type:"POST",global:!0,dataType:"json"};e=$.extend({},n,e);var s=e.doneHasErrorIsReload;delete e.doneHasErrorIsReload;var r=$.ajax(e);return t&&this.ajaxSuccessCall(r,a,s),r},ajaxSuccessCall:function(e,t,a){var n=this;e.done(function(e){if(0!=e.status)n.ajaxSuccessFailCall(e,a);else{if("undefined"==typeof t)return;n.render(e,t)}})},ajaxSuccessFailCall:function(e,t){var a=e.msg,n=this;n.layerAlertId=layer.alert(a,function(){layer.close(n.layerAlertId),t&&window.location.reload(!0)})},render:function(e,t){var a=document.getElementById(t[0]).innerHTML;return"undefined"==typeof e.data?void layer.alert("亮老板数据返回错误 。。"):(t[0]==GLOBALAJAX.addressTmp&&(e.data.address_list.length<=0?($(".js_add_aaddress,.js_address_confirm_cancel").hide(),$(ORDERADDRESS.addressFormId).show(),ORDERADDRESS.addressForm instanceof ADDRESSFORM&&ORDERADDRESS.addressForm.formReset(),ORDERADDRESS.renderCallBack()):($(".js_add_aaddress,.js_address_confirm_cancel").show(),$(ORDERADDRESS.addressFormId).hide())),laytpl(a).render(e.data,function(a){document.getElementById(t[1]).innerHTML=a,t[2]=t[2]||$.noop,t[2].call(ORDERADDRESS,e)}),void(t[0]==GLOBALAJAX.checkoutTmp&&GLOBAL.otherGlobal.myPlaceholder.init($("#"+GLOBALAJAX.orderConfirmForm).find(".js_myPlaceholder"),31)))}},window.ORDERADDRESS={addressForm:"",addressFormId:"#delivery_address_form",layerIndex:null,init:function(){var e=this,t=GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.getAddressListUrl},!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWrap,function(t){e.renderCallBack(),e.checkPopVerified(t.data.verified)}]);t.fail(function(){layer.alert("获取数据失败！",function(){window.location.reload(!0)})}),this.initUseCurrentEvent()},renderCallBack:function(){var e=this;!$(e.addressFormId).is(":visible")||e.addressForm instanceof ADDRESSFORM||(e.addressForm=new ADDRESSFORM($(e.addressFormId),function(){var t=$(e.addressFormId).serialize();GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.saveAddressUrl,data:t},!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWrap,function(t){layer.close(e.layerIndex),0==t.status&&e.checkPopVerified(t.data.verified)}]).fail(function(){layer.alert("保存失败！",function(){window.location.reload(!0)})})}))},allOperating:function(e){e=e||{};var t=this,a=GLOBALAJAX.getCartAjaxPromise(e,!0,[GLOBALAJAX.addressTmp,GLOBALAJAX.addressWrap]);return a.done(function(e){0==e.status&&t.checkPopVerified(e.data.verified)}),a},setCurrentStyle:function(e){e.closest(".js_addressTable").find(".js_address_label").removeClass("checked"),e.addClass("checked")},setDefaultStyle:function(e){var t=$("#"+GLOBALAJAX.addressWrap).find(".js_defaultWarp");t.removeClass("js_defaultWarp"),t.find(".js_default").addClass("hidden"),t.find(".js_setDefault").removeClass("hidden");var a=e.closest(".js_address_label");a.addClass("js_defaultWarp"),a.find(".js_default").removeClass("hidden"),a.find(".js_setDefault").addClass("hidden")},setDefaultAndCurrent:function(e){return e=$.extend({global:!0},e),GLOBALAJAX.getCartAjaxPromise(e,!0)},openPop:function(e,t){var a=$("#js_pop"),n=this;if(e=$.extend({},{type:1,shadeClose:!1,title:"提示",area:["500px","350px"],content:a,end:function(){}},e),n.layerIndex=layer.open(e),t=arguments.length>1?t:!1){a=e.content;var s=a.find(".js_cancel");s.off("click"),s.on("click",function(e){e.preventDefault(),layer.close(n.layerIndex)})}},checkPopVerified:function(e){var t="1"==directMail&&0==e&&$(".js_address_label").length>0;if(t){var a,n=$(".js_address_label").filter(".checked").data("address-id");a=void 0==n?GLOBALAJAX.userEditAddressUrl.replace("?edit_address_id={address_id}",""):GLOBALAJAX.userEditAddressUrl.replace("{address_id}",n),$(".js_addressVer").attr("href",a),this.openPop({area:["500px","320px"]},!0)}return!t},initUseCurrentEvent:function(){var e=this;$("#js_address_warp").on("click",".js_address_label",function(){var t=$(this),a=t.data("address-id")||0;t.hasClass("checked")||e.setDefaultAndCurrent({url:GLOBALAJAX.setCurrentUseAddressUrl,data:{address_id:a}}).fail(function(){layer.alert("选择失败，点击确定重试",function(){window.location.reload(!0)})}).done(function(a){0==a.status&&(e.setCurrentStyle(t),e.checkPopVerified(a.data.verified))})}),$(".js_add_aaddress").on("click",function(t){return t.preventDefault(),$("#"+GLOBALAJAX.addressWrap).find(".js_address_label").length>=9?(layer.alert("最多设置 9 个收货地址，请先删除"),!1):void e.editOrAdd()}),$(".js_address_confirm_cancel").click(function(t){t.preventDefault(),layer.close(e.layerIndex)})},stopPropagation:function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0},setDefaultEvent:function(e,t,a){var n=this;n.stopPropagation(t),n.setDefaultAndCurrent({url:GLOBALAJAX.setDefaultAddressUrl,data:{address_id:a}}).fail(function(){layer.alert("设置当前默认失败，点击确定重试",function(){window.location.reload(!0)})}).done(function(){n.setDefaultStyle($(e))})},deleteEvent:function(e,t){var a=this;this.stopPropagation(e),layer.confirm("确定要删除该收货地址吗？",{btn:["确认","取消"],shade:.3},function(){a.allOperating({url:GLOBALAJAX.deleteAddressUrl,data:{address_id:t}}).fail(function(){layer.alert("删除失败，点击确定重试",function(){window.location.reload(!0)})})},function(){})},editEvent:function(e,t){var a=this;this.stopPropagation(e),GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.editAddressUrl,data:{address_id:t}},!0).done(function(e){return 0==e.status?a.editOrAdd(e):void 0}).fail(function(){layer.alert("获取数据失败，点击确定重试",function(){window.location.reload(!0)})})},showAllEvent:function(e){this.stopPropagation(e),$(".show_all").show(),$(".js_showAllAddress").remove()},checkIsJsonData:function(e){var t="object"==typeof e&&"[object object]"==Object.prototype.toString.call(e).toLowerCase()&&!e.length;if(t)return e;if("string"==typeof e)try{return $.parseJSON(e)}catch(a){return!1}},bindFormData:function(e){if(!this.checkIsJsonData(e))return!1;var t=$(this.addressFormId);t.find("input").each(function(){this.value="undefined"==typeof e.data[this.name]?"":e.data[this.name]}),t.find("textarea").each(function(){this.value="undefined"==typeof e.data[this.name]?"":e.data[this.name]}),t.find(".hidden-input").each(function(){var t=!("undefined"==typeof e.data[this.name]||1!=e.data[this.name]);this.checked=t,this.value=1,t?$(this).siblings(".icon_checkbox").addClass("selected"):$(this).siblings(".icon_checkbox").removeClass("selected")}),t.find("select").each(function(){var t='<option value="default">'+$(this).find("option:first").text()+"</option>",a=e.data[this.name];if(!(a.length>0))return!1;$(this).parent().show();for(var n=0;n<a.length;n++)t+="1"==a[n].is_current?'<option selected="selected" value="'+a[n].id+'">'+a[n].value+"</option>":'<option value="'+a[n].id+'">'+a[n].value+"</option>";$(this).html(t)})},editOrAdd:function(e){var t;ORDERADDRESS.addressForm instanceof ADDRESSFORM&&ORDERADDRESS.addressForm.formReset(),"undefined"!=typeof e?(t="修改收货地址",this.bindFormData(e)):(t="添加收货地址",$(ORDERADDRESS.addressFormId).find("input[name=address_id]").val(""));var a=.8*$(window).height();a=(a>600?600:a)+"px",this.layerIndex=layer.open({type:1,shadeClose:!1,title:t,area:["800px",a],content:$(this.addressFormId)}),this.renderCallBack()}},window.CHECKOUT={selectTimer:null,codeTimer:null,countdownTimer:null,maxMenoy:{use_gift_money:10,use_commission_money:0},setCheckBox:function(e){$(e).toggleClass("selected");var t=$(e).siblings(".hidden-input")[0];t.checked=!t.checked},encryptionGiftCard:function(e){void 0!=e&&(e+="");var t=e.length;return t>=6?e.substr(0,3)+"******"+e.substr(t-3,3):e},init:function(){this.allOperating({url:GLOBALAJAX.getCartDataUrl}).fail(function(){layer.alert("获取订单列表失败，点击确定重试",function(){window.location.reload(!0)})}),this.bindEvent()},bindEvent:function(){var e=this,t=$("#"+GLOBALAJAX.orderConfirmForm);t.on("click",".js_use_coupon,.js_use_commission",function(){var t=$(this);if(t.parent().siblings(".js_noneShow").toggleClass("none"),t.hasClass("js_use_commission")){var a=$(".js_useCommissionMoney")[0];a.disabled=!a.disabled}clearTimeout(this.selectTimer),this.selectTimer=setTimeout(function(){if(!t.hasClass("selected"))if(t.hasClass("js_use_coupon")){if("default"==t.closest(".user_coupon_warp").find(".item-select").val())return;e.allOperating({url:GLOBALAJAX.useCouponUrl,data:{code:0}}).fail(function(){layer.alert("取消优惠券使用失败，点击确定重试",function(){window.location.reload(!0)})})}else t.parent().parent().find(".form-error").remove(),e.allOperating({url:GLOBALAJAX.useCommissionUrl,data:{commission:0}}).fail(function(){layer.alert("取消使用佣金失败，点击确定重试",function(){window.location.reload(!0)})})},100)}),t.on("click",".js_get_commission_code",function(t){t.preventDefault(),$this=$(this),$this.hasClass("disabled")||GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.getSecurityCode},!0).done(function(t){if(0==t.status){$this.addClass("disabled").data("default-text",$this.text()),$(".js_send_code_msg").show();var a=60;clearInterval(e.countdownTimer),e.countdownTimer=setInterval(function(){$this.text(a),a--,0>=a&&($this.removeClass("disabled").text($this.data("default-text")),clearInterval(e.countdownTimer))},1e3)}}).fail(function(){layer.alert("获取验证码失败，点击确定重试",function(){window.location.reload(!0)})})}),t.on("click",".js_userCoponCode",function(){t.find(".js_couponCodeWarp").toggle()}),t.on("click",".js_useGiftCardBtn",function(){var a=$(".js_cardList"),n=$(this),s=a.length>0;if(a.toggle(),n.hasClass("selected"))s?e.setCheckoutBtnDisabled(t):(e.setCheckBox(this),e.exChangeGiftCard());else if(e.removeCheckOutBtnDisabled(t),s){var r=$(".js_selectGiftCard");"default"!=r.val()&&(r.val("default"),e.selectGiftCartEvent(r[0]))}}),t.on("click",".js_submit",function(e){$(this).hasClass("disabled")&&e.preventDefault()})},exChangeGiftCard:function(){var e=this;e.cardPop instanceof GiftCardForm||(e.cardPop=new GiftCardForm(function(t){e.allOperating({url:GLOBALAJAX.bindGiftCartUrl,data:this.serialize(),doneHasErrorIsReload:!1}).fail(function(){layer.alert("激活礼品卡失败，点击确定重试",function(){})}).always(function(){layer.close(t)}).done(function(e){0!=e.status&&$(".js_selectGiftCard").val("default")})})),e.cardPop.open()},checkCoupon:function(){var e=$("#"+GLOBALAJAX.orderConfirmForm).find(".js_couponCode"),t=e.val().length>=8&&e.val().length<=16?e.val():!1;return t||layer.alert("请输入正确的优惠券兑换码！",{end:function(){e.val("").focus()}}),t},exchangeCoupon:function(){var e=this.checkCoupon();e&&this.allOperating({url:GLOBALAJAX.getExchangeCoupon,data:{coupon_code:e}}).fail(function(){layer.alert("兑换失败")})},getSecurityCodeEvent:function(){},checkisNna:function(e){return!isNaN(e)},setMaxMenoy:function(e){var t=e.data.total.order_amount-0+e.data.commission_money,a=e.data.total.order_amount-0+(e.data.gift_money-0),n=$(".js_selectGiftCard").find("option:selected"),s="default"!=n.val()&&n.length>0?n.data("over-money"):0;CHECKOUT.maxMenoy.use_commission_money=e.data.commission_over>t?t:e.data.commission_over,CHECKOUT.maxMenoy.use_gift_money=s>a?a:s,$(".js_useGiftCardInput").val(parseFloat(CHECKOUT.maxMenoy.use_gift_money).toFixed(2))},getCurrentMaxMenoy:function(e){return CHECKOUT.maxMenoy[e]},blurMenoyInput:function(e){e.value=""==e.value?0:parseFloat(e.value).toFixed(2)},checkMenoyMax:function(e){var t=this.getCurrentMaxMenoy(e.name),a=parseFloat(e.value);""==e.value||this.checkisNna(a)&&t>=a||(e.value=t)},commissionChangeEvent:function(e){var t=parseFloat($(e).data("has-commission")),a=parseFloat(e.value);""==e.value||this.checkisNna(a)&&t>=a||(e.value=t)},lengthValidate:function(e,t){return t=t||6,e.value.length==t},getInputCodeEventConfig:function(e){var t={};switch(e){case".js_useCommissionMoney":t={inputEmptyMsg:"请输入要使用的佣金金额",instanceErrorMsg:"验证码长度为6位",ajax:{url:GLOBALAJAX.useCommissionUrl,data:"{commission : $input[0].value,security_code : elm.value}",failCallBack:function(){layer.alert("使用佣金失败，点击确定重试",function(){window.location.reload(!0)})}}};break;case".js_useGiftCardInput":t={inputEmptyMsg:"请输入要使用礼品卡付款金额",instanceErrorMsg:"支付密码长度为6位",ajax:{url:GLOBALAJAX.useGiftCartUrl,data:'{money : $input[0].value,pass : elm.value.toUpperCase(),code: $(".js_selectGiftCard").val()}',failCallBack:function(){layer.alert("礼品卡使用失败，点击确定重试",function(){window.location.reload(!0)})}}}}return t},inputCodeEvent:function(elm,inputSelector){var that=this,$input=$(inputSelector),eventConfig=that.getInputCodeEventConfig(inputSelector);clearTimeout(this.codeTimer),that.codeTimer=setTimeout(function(){if($(elm).removeClass("form-error"),$(elm).closest(".js_errorWrap").find(".form-error").remove(),that.lengthValidate(elm)){if(""==$input[0].value)return layer.alert(eventConfig.inputEmptyMsg,{end:function(){$input.focus()}}),elm.value="",!1;var ajaxData;try{eval("ajaxData = "+eventConfig.ajax.data)}catch(exception){return alert("error"),!1}that.allOperating({url:eventConfig.ajax.url,data:ajaxData,doneHasErrorIsReload:!1}).fail(function(){eventConfig.ajax.failCallBack()}).done(function(e){0!=e.status&&$(elm).val("").focus()})}else $(elm).addClass("form-error").focus(),$(elm).closest(".js_errorWrap").append("<p class='form-error'>"+eventConfig.instanceErrorMsg+"</p>")},1e3)},selectCouponEvent:function(e){var t="default"==e.value?0:e.value;this.allOperating({url:GLOBALAJAX.useCouponUrl,data:{code:t}}).fail(function(){layer.alert("选择优惠券失败，点击确定重试",function(){window.location.reload(!0)})})},selectGiftCartEvent:function(e){var t=this;return"new-card"==$(e).val()?(t.exChangeGiftCard(),$(".js_hideUseGift").hide(),!1):void GLOBALAJAX.getCartAjaxPromise({url:GLOBALAJAX.useGiftCartUrl,data:{code:0}},!1).done(function(a){if(0==a.status){var n=$(".js_hideUseGift");$(".js_cardMoney").html(" -￥0"),$(".js_totalMoney").html(a.data.total.order_amount),$(".js_useCommissionMoney").val(a.data.commission_over),$(".js_commisonCanMoney").html(a.data.commission_over),t.setMaxMenoy(a),"default"==$(e).val()?(n.find("input").val(""),n.hide()):n.show()}}).fail(function(){layer.alert("选择礼品卡失败，点击确定重试",function(){window.location.reload(!0)})})},allOperating:function(e){e=e||{};var t=GLOBALAJAX.getCartAjaxPromise(e,!0,[GLOBALAJAX.checkoutTmp,GLOBALAJAX.orderConfirmForm]),a=this;return t.done(function(e){0==e.status&&a.setMaxMenoy(e)}),t},setCheckoutBtnDisabled:function(e){var t=e.find(".js_submit");t.addClass("disabled"),e.find(".js_notice").show()},removeCheckOutBtnDisabled:function(e){e.find(".js_submit").removeClass("disabled"),e.find(".js_notice").hide()}},$(function(){directMail=$("#js_directMail").val(),ORDERADDRESS.init(),CHECKOUT.init()})}(jQuery,window);