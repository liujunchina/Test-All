!function(t,a){a.CART={getDataUrl:"/m-flow-a-get_cart.html",updateGoodsNumUrl:"/m-flow-a-update_cart.html",deleteGoodsUrl:"/m-flow-a-drop_goods.html",clearCartUrl:"/m-flow-a-clear.html",updateSelectStatusUrl:"/m-flow-a-checked_cart.html",maxGoodsNum:999999,inputTimer:null,isRequesting:!1,minCartTpl:'{{# if(d.cart_list.length <=0 ){ }}<div class="empty-cart min-cart-content"><p class="empty-text">您的购物车还是空的<br/>赶紧行动吧！</p><p class="total"><a href="/" class="checkout-btn btn btn-default btn-sm">去逛逛</a></p></div>{{# }else{ }}<div class="cart-list min-cart-content"><h4 class="title"><span>最近加入的商品</span></h4><ul class="list">{{#var cartList = d.cart_list,minCartLength=(d.cart_list.length >4) ? 4 : d.cart_list.length;for(var i = 0; i < minCartLength; i++){ }}<li><div class="goods-img"><a href="{{cartList[i].url}}"><img src="{{cartList[i].img}}" alt="{{cartList[i].title}}" width="58" height="58" /></a></div><div class="goods-info"><p class="goods-title"><a href="{{cartList[i].url}}" title="{{cartList[i].title}}">{{cartList[i].title}}</a></p><p class="goods-num"><a class="cart_goods_minus js_update_num" href="javascript:void (0)">-</a><input type="text" data-value="3" class="cart_goods_num" data-cart-id="{{cartList[i].cart_id}}" onkeyup="CART.changeEvent(this)" value="{{cartList[i].goods_num}}"><a class="cart_goods_plus js_update_num" href="javascript:void (0)">+</a></p></div><a class="icon-remove-sm icon js_cart_remove" href="javascript:void (0)" data-cart-id="{{cartList[i].cart_id}}"></a><div class="item-total">￥{{cartList[i].sub_total}}</div></li>{{# } }}</ul><p class="total"><span class="num">共 <span class="color-increase">{{(d.cart_num) ? d.cart_num : 0}}</span> 件商品</span><a href="/m-flow-a-cart.html" class="checkout-btn btn btn-default btn-sm">去购物车</a></p></div>{{# } }}',getCartAjaxPromise:function(a,e){var s=this;e=arguments.length>1?e:!0;var i={type:"POST",global:!this.isMinCart,dataType:"json"};a=t.extend({},i,a),s.isRequesting=!0;var r=t.ajax(a);return e&&s.ajaxSuccessCall(r),r.always(function(){s.isRequesting=!1}),r},checkIsSelectAll:function(){var t=this;if(!t.isMinCart){var a=t.$parentForm.find(".js_select_tiem");a.length==a.filter(".selected").length?t.$parentForm.find(".js_select_all").addClass("selected"):t.$parentForm.find(".js_select_all").removeClass("selected")}},firstCartTrack:function(t){!function(a,e,s){function i(){e.body?(o=e.createElement("script"),o.src=u,e.body.insertBefore(o,e.body.firstChild)):setTimeout(i(),100)}var r=0,n="";for(var l in t.data.cart_list)r=r-0+(t.data.cart_list[l].sub_total-0),n+=t.data.cart_list[l].goods_id+","+t.data.cart_list[l].goods_num+";";var c,o,d=location.href,m=e.referrer,h=e.cookie,p=h.match(/(^|;)\s*ipycookie=([^;]*)/),l=h.match(/(^|;)\s*ipysession=([^;]*)/);a.parent!=a&&(c=d,d=m,m=c),u="//stats.ipinyou.com/cvt?a="+s("M2s.nzs.iqilqD6VCH_iOBRqYEp9SP")+"&c="+s(p?p[2]:"")+"&s="+s(l?l[2].match(/jump\%3D(\d+)/)[1]:"")+"&u="+s(d)+"&r="+s(m)+"&rd="+(new Date).getTime()+"&Money="+s(r)+"&ProductList="+s(n)+"&e=",i()}(a,document,encodeURIComponent)},bindEvent:function(){var a=this;a.$parentForm=t("#"+a.cartTmpId),a.$parentForm.length>0&&(a.$parentForm.on("click",".js_update_num",function(e){if(e.preventDefault(),a.isRequesting)return!1;var s,i=t(this).siblings(".cart_goods_num"),r=i.val()||1,n=t(this).hasClass("cart_goods_plus");if(n)s=++r>=CART.maxGoodsNum?CART.maxGoodsNum:r;else{if(1==r)return;s=--r}i.val(s);var l=i.data("cart-id");CART.changeNum(s,l)}),a.$parentForm.on("click",".js_cart_remove",function(a){a.preventDefault(),CART.remove(t(this).data("cart-id"))}),a.isMinCart||(a.$parentForm.on("click",".js_select_checkbox",function(){t(this).toggleClass("selected");var e;t(this).hasClass("js_select_all")?t(this).hasClass("selected")?(a.$parentForm.find(".js_select_checkbox").addClass("selected"),e=2):(a.$parentForm.find(".js_select_checkbox").removeClass("selected"),e=3):e=t(this).hasClass("selected")?1:0,CART.selectCart(t(this).data("cart-id"),e)}),a.$parentForm.on("click",".js_submit",function(a){t(this).hasClass("disabled")&&a.preventDefault()})))},init:function(t,e,s){var i=this;if(i.isMinCart=t,i.cartTmpId=e,i.bindEvent(),void 0==s){var r=this.getCartAjaxPromise({url:this.getDataUrl},!1);r.done(function(t){0==status?(i.render(t),i.isMinCart||i.firstCartTrack(t)):i.ajaxFailCall(t)}).fail(function(){layer.alert("获取购物车信息失败，点击确定重试",function(){a.location.reload(!0)})})}else 0==status?(i.render(s),i.isMinCart||i.firstCartTrack(s)):i.ajaxFailCall(s)},getLaytpl:function(t){"undefined"==typeof laytpl?$LAB.script("laytpl.min.js?2015101001").wait(function(){t()}):t()},render:function(a){var e,s=this;e=s.isMinCart?s.minCartTpl:document.getElementById("cart_tmp").innerHTML,"undefined"!=typeof a.data.cart_num&&t("#js_topCartNum,#js_leftCartNum").text(a.data.cart_num),s.getLaytpl(function(){laytpl(e).render(a.data,function(t){document.getElementById(s.cartTmpId).innerHTML=t}),s.checkIsSelectAll()})},checkGoodsNum:function(t){return parseInt(t)==t&&t>0&&t<=this.maxGoodsNum},changeEvent:function(a){var e=this,s=a.value,i=t(a).data("cart-id");clearTimeout(e.inputTimer),this.checkGoodsNum(s)?this.inputTimer=setTimeout(function(){e.changeNum(s,i)},800):a.value=t(a).data("value")},changeNum:function(t,a){this.getCartAjaxPromise({url:this.updateGoodsNumUrl,data:{cart_id:a,goods_number:t}})},remove:function(t){this.getCartAjaxPromise({url:this.deleteGoodsUrl,data:{cart_id:t}})},selectCart:function(t,a){var e={selected:a};(0==a||1==a)&&(e.cart_id=t),this.getCartAjaxPromise({url:this.updateSelectStatusUrl,data:e})},ajaxSuccessCall:function(t){var a=this;t.done(function(t){0!=t.status?a.ajaxFailCall(t):a.render(t)})},ajaxFailCall:function(t){var e=t.msg;layer.alert(e,function(){a.location.reload(!0)})}}}(jQuery,window);